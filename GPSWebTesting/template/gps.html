<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>GPS en tiempo real</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
    <h2>Seguimiento GPS</h2>

    <button onclick="sendLocation()">Enviar mi ubicación</button>

    <h3>Buscar Ruta Manual</h3>
    <input type="text" id="start" placeholder="Dirección de inicio" style="width: 250px;">
    <input type="text" id="end" placeholder="Dirección de destino" style="width: 250px;">
    <button onclick="searchRoute()">Obtener Ruta</button>

    <h3>Rutas Guardadas</h3>
    <select id="routesList" style="width:300px;">
        <option value="">-- Selecciona una ruta guardada --</option>
    </select>
    <button onclick="useSavedRoute()">Usar Ruta Guardada</button>

    <div id="map" style="height:400px; width:100%; margin-top:10px;"></div>

    <script>
        // ENVIAR UBICACIÓN ACTUAL
        function sendLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(function(position) {
                    fetch("/gps/api/locations/", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        })
                    });
                });
            } else {
                alert("Geolocalización no soportada");
            }
        }

        // CONFIGURAR MAPA
        var map = L.map('map').setView([0, 0], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        var marker = L.marker([0, 0]).addTo(map);
        var endMarker = null;
        var routeLine = null;

        // ACTUALIZAR GPS AUTOMÁTICO
        setInterval(async function() {
            let res = await fetch("/gps/api/locations/");
            let data = await res.json();

            if (data.length > 0) {
                let pos = [data[0].latitude, data[0].longitude];

                marker.setLatLng(pos);
                map.setView(pos);

                if (routeLine && endMarker) {
                    map.removeLayer(routeLine);
                    routeLine = L.polyline([
                        pos,
                        endMarker.getLatLng()
                    ]).addTo(map);
                }
            }
        }, 5000);

        // OBTENER COORDENADAS DESDE DIRECCIONES (GEOCODING)
        async function getRouteFromAddresses(startAddress, endAddress) {
            const res = await fetch("/gps/api/locations/route/", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    start_address: startAddress,
                    end_address: endAddress
                })
            });

            return await res.json();
        }

        // BUSCAR RUTA Y GUARDARLA EN LA BASE DE DATOS
        async function searchRoute() {
            let startAddress = document.getElementById("start").value;
            let endAddress = document.getElementById("end").value;

            if (!startAddress || !endAddress) {
                alert("Ingresa inicio y destino");
                return;
            }

            let route = await getRouteFromAddresses(startAddress, endAddress);

            if (route.error) {
                alert("No se pudo obtener la ruta");
                return;
            }

            drawRoute(route.start, route.end);

            // GUARDAR RUTA EN BD
            await fetch("/gps/api/routes/", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    start_lat: route.start.latitude,
                    start_lon: route.start.longitude,
                    end_lat: route.end.latitude,
                    end_lon: route.end.longitude
                })
            });

            alert("Ruta guardada");
            loadSavedRoutes();
        }

        // USAR RUTA GUARDADA
        function useSavedRoute() {
            let value = document.getElementById("routesList").value;

            if (!value) {
                alert("Selecciona una ruta guardada");
                return;
            }

            let [sLat, sLon, eLat, eLon] = value.split(",");

            drawRoute(
                { latitude: parseFloat(sLat), longitude: parseFloat(sLon) },
                { latitude: parseFloat(eLat), longitude: parseFloat(eLon) }
            );
        }

        // DIBUJAR RUTA EN EL MAPA
        function drawRoute(start, end) {
            if (endMarker) map.removeLayer(endMarker);
            if (routeLine) map.removeLayer(routeLine);

            let endPos = [end.latitude, end.longitude];

            endMarker = L.marker(endPos).addTo(map).bindPopup("Destino");

            routeLine = L.polyline([marker.getLatLng(), endPos]).addTo(map);

            map.fitBounds([marker.getLatLng(), endPos]);
        }

        // CARGAR RUTAS GUARDADAS DESDE LA BD
        async function loadSavedRoutes() {
            let res = await fetch("/gps/api/routes/");
            let routes = await res.json();

            let list = document.getElementById("routesList");
            list.innerHTML = `<option value="">-- Selecciona una ruta guardada --</option>`;

            routes.forEach(r => {
                list.innerHTML += `
                    <option value="${r.start_lat},${r.start_lon},${r.end_lat},${r.end_lon}">
                        Ruta ${r.id} - ${r.created_at}
                    </option>
                `;
            });
        }

        loadSavedRoutes();
    </script>
</body>
</html>
